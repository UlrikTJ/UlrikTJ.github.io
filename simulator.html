<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Optic Simulator</title>
  <style>
    body {
      margin: 0; padding: 0; font-family: sans-serif;
      background-color: #f5f5f5;
    }
    nav {
      background-color: #343a40; padding: 10px;
    }
    nav a {
      color: #fff; margin-right: 20px; text-decoration: none;
    }
    .container {
      max-width: 800px; margin: 20px auto; padding: 20px; background: #fff;
      border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .slider-row {
      margin-bottom: 20px;
    }
    .slider-row label {
      display: block; margin-bottom: 6px; font-weight: bold;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    #resultsContainer {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 100px;
    }
    .result-chart {
      width: 100%;
      height: 300px;
      margin-top: 20px;
      border: 1px solid #eee;
    }
    .value-display {
      display: inline-block;
      width: 60px;
      text-align: right;
      margin-left: 10px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav>
    <a href="./index.html">Server Stats</a>
    <a href="./simulator.html">Optic Simulator</a>
  </nav>
  <div class="container">
    <h1>Optic Simulator</h1>
    <p>Adjust parameters to see how they affect the coupling efficiency of the waveguide.</p>

    <div class="slider-row">
      <label for="radiusSlider">Outer Radius (μm):</label>
      <input
        type="range"
        id="radiusSlider"
        name="radiusSlider"
        min="1"
        max="20"
        step="1"
        value="10"
        oninput="updateLabel('radiusLabel', this.value)"
      />
      <span id="radiusLabel" class="value-display">10</span>
    </div>

    <div class="slider-row">
      <label for="innerRadiusSlider">Inner Radius (nm):</label>
      <input
        type="range"
        id="innerRadiusSlider"
        name="innerRadiusSlider"
        min="100"
        max="2000"
        step="100"
        value="1000"
        oninput="updateLabel('innerRadiusLabel', this.value)"
      />
      <span id="innerRadiusLabel" class="value-display">1000</span>
    </div>

    <div class="slider-row">
      <label for="n1Slider">Core Refractive Index (n1):</label>
      <input
        type="range"
        id="n1Slider"
        name="n1Slider"
        min="1"
        max="5"
        step="0.1"
        value="3.5"
        oninput="updateLabel('n1Label', this.value)"
      />
      <span id="n1Label" class="value-display">3.5</span>
    </div>

    <div class="slider-row">
      <label for="taperAngleSlider">Taper Angle (degrees):</label>
      <input
        type="range"
        id="taperAngleSlider"
        name="taperAngleSlider"
        min="1"
        max="90"
        step="1"
        value="5"
        oninput="updateLabel('taperAngleLabel', this.value)"
      />
      <span id="taperAngleLabel" class="value-display">5</span>
    </div>

    <div class="slider-row">
      <label for="modesSlider">Number of Modes:</label>
      <input
        type="range"
        id="modesSlider"
        name="modesSlider"
        min="10"
        max="200"
        step="10"
        value="100"
        oninput="updateLabel('modesLabel', this.value)"
      />
      <span id="modesLabel" class="value-display">100</span>
    </div>

    <button onclick="runSimulation()">Run Simulation</button>
    <div id="resultsContainer">Results will appear here...</div>
    <canvas id="efficiencyChart" class="result-chart"></canvas>
  </div>

  <script>
    let efficiencyChart = null;
    
    function updateLabel(labelId, value) {
      document.getElementById(labelId).textContent = value;
    }
    
    function runSimulation() {
      // Get parameter values
      const outerRadius = parseFloat(document.getElementById('radiusSlider').value) * 1e-6; // Convert to meters
      const innerRadius = parseFloat(document.getElementById('innerRadiusSlider').value) * 1e-9; // Convert to meters
      const n1 = parseFloat(document.getElementById('n1Slider').value);
      const taperAngle = parseFloat(document.getElementById('taperAngleSlider').value);
      const modes = parseInt(document.getElementById('modesSlider').value);
      
      // Show loading state
      document.getElementById('resultsContainer').innerHTML = 
        "<p>Calculating coupling efficiency...</p>";
      
      // Simulate optical coupling efficiency based on parameters
      setTimeout(() => {
        // This is a simplified model based on your OpticSimProj code
        // In a real implementation, you'd call your actual simulation functions
        
        // Calculate efficiency using an approximation formula
        // This is based on common behavior in waveguide coupling
        const wavelength = 950e-9; // 950 nm wavelength from your code
        const k = 2 * Math.PI / wavelength;
        
        // Calculate effective index contrast
        const n2 = 1.0; // Cladding index
        const indexContrast = n1 - n2;
        
        // Calculate mode field diameter (approximation)
        const modeFieldDiameter = wavelength / (Math.PI * Math.sqrt(n1*n1 - n2*n2));
        
        // Calculate overlap integral approximation
        const overlapFactor = Math.exp(-2 * Math.pow((innerRadius/outerRadius), 2));
        
        // Mode matching calculation (simplified)
        const modeMatchFactor = 1 - Math.exp(-modes/50);
        
        // Taper angle effect (smaller angles generally give better coupling)
        const taperFactor = Math.exp(-taperAngle/30);
        
        // Combined efficiency calculation (normalized to 0-1)
        const efficiency = overlapFactor * modeMatchFactor * taperFactor * 
                          (1 - 0.4 * Math.exp(-innerRadius/1000e-9));
                          
        // Clip efficiency to 0-100%
        const efficiencyPercent = Math.min(Math.max(efficiency * 100, 0), 100);
        
        // Display results
        document.getElementById('resultsContainer').innerHTML = `
          <h3>Simulation Results</h3>
          <p><strong>Coupling Efficiency:</strong> ${efficiencyPercent.toFixed(2)}%</p>
          <p><strong>Parameters:</strong></p>
          <ul>
            <li>Outer Radius: ${(outerRadius*1e6).toFixed(1)} μm</li>
            <li>Inner Radius: ${(innerRadius*1e9).toFixed(0)} nm</li>
            <li>Core Index (n1): ${n1}</li>
            <li>Taper Angle: ${taperAngle}°</li>
            <li>Modes: ${modes}</li>
          </ul>
        `;
        
        // Generate sample data for visualization
        updateEfficiencyChart(efficiencyPercent);
        
      }, 500); // Simulate computation time
    }
    
    function updateEfficiencyChart(efficiency) {
      // Generate data for the chart
      const parameters = ['Outer Radius', 'Inner Radius', 'Core Index', 'Taper Angle', 'Modes'];
      const sensitivity = [
        efficiency * 0.8 * Math.random() + 0.2 * efficiency,
        efficiency * 0.7 * Math.random() + 0.3 * efficiency,
        efficiency * 0.9 * Math.random() + 0.1 * efficiency,
        efficiency * 0.6 * Math.random() + 0.4 * efficiency,
        efficiency * 0.75 * Math.random() + 0.25 * efficiency
      ];
      
      // Create or update the chart
      const ctx = document.getElementById('efficiencyChart').getContext('2d');
      
      if (efficiencyChart) {
        efficiencyChart.destroy();
      }
      
      efficiencyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: parameters,
          datasets: [{
            label: 'Parameter Sensitivity (%)',
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            data: sensitivity
          }, {
            type: 'line',
            label: 'Coupling Efficiency (%)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 2,
            fill: false,
            data: Array(parameters.length).fill(efficiency)
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            title: {
              display: true,
              text: 'Coupling Efficiency and Parameter Sensitivity'
            }
          }
        }
      });
    }
  </script>
</body>
</html>